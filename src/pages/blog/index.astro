---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { withBase } from "../../utils/paths.js";

const posts = (await getCollection("posts"))
  .filter((post) => post.data.status === "published")
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const categories = Array.from(
  new Set(posts.map((post) => post.data.category).filter(Boolean))
);
---

<BaseLayout title="블로그" description="유자살롱의 글 모음" showMusicPlayer={false}>
  <section class="section">
    <div class="blog-layout">
      <aside class="blog-sidebar" aria-label="카테고리">
        <h2 class="sidebar-title">카테고리</h2>
        {categories.length > 0 ? (
          <nav class="category-nav">
            <a class="category-link" href={withBase("/blog")}>전체</a>
            {categories.map((category) => (
              <a class="category-link" href={withBase(`/category/${category}`)}>
                {category}
              </a>
            ))}
          </nav>
        ) : (
          <p class="sidebar-empty">등록된 카테고리가 없습니다.</p>
        )}
      </aside>
      <div class="blog-content">
        <h1 class="section-heading">블로그</h1>
        {posts.length === 0 ? (
          <p>아직 마이그레이션된 글이 없습니다. 곧 글들이 추가됩니다.</p>
        ) : (
          <div class="post-list">
            {posts.map((post) => (
              <article class="post-card">
                <a href={withBase(`/blog/${post.slug}`)}>
                  <h2>{post.data.title}</h2>
                  {post.data.summary ? <p>{post.data.summary}</p> : null}
                  <span class="post-meta">
                    {post.data.pubDate.toLocaleDateString("ko-KR")}
                    {post.data.category ? ` · ${post.data.category}` : ""}
                  </span>
                </a>
              </article>
            ))}
          </div>
        )}
      </div>
    </div>
  </section>
</BaseLayout>
