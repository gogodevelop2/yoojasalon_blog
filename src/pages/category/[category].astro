---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { withBase } from "../../utils/paths.js";

export async function getStaticPaths() {
  const allPosts = await getCollection("posts");
  const publishedPosts = allPosts.filter((post) => post.data.status === "published");
  const categories = Array.from(
    new Set(publishedPosts.map((post) => post.data.category).filter(Boolean))
  );

  return categories.map((category) => ({
    params: { category },
    props: {
      category,
      // NOTE: getStaticPaths에서 계산한 데이터를 props로 전달하여 이중 조회 방지
      allCategories: categories,
      categoryPosts: publishedPosts
        .filter((post) => post.data.category === category)
        .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()),
    },
  }));
}

const { category, allCategories, categoryPosts } = Astro.props;
---

<BaseLayout title={`${category} · 유자살롱`} description={`${category} 카테고리 글 모음`} showMusicPlayer={false}>
  <section class="section">
    <div class="blog-layout">
      <aside class="blog-sidebar" aria-label="카테고리">
        <h2 class="sidebar-title">카테고리</h2>
        {allCategories.length > 0 ? (
          <nav class="category-nav">
            <a class="category-link" href={withBase("/blog")}>
              전체
            </a>
            {allCategories.map((item) => (
              <a
                class={`category-link${item === category ? " is-active" : ""}`}
                href={withBase(`/category/${item}`)}
              >
                {item}
              </a>
            ))}
          </nav>
        ) : (
          <p class="sidebar-empty">등록된 카테고리가 없습니다.</p>
        )}
      </aside>
      <div class="blog-content">
        <h1 class="section-heading">{category}</h1>
        {categoryPosts.length === 0 ? (
          <p>아직 이 카테고리에 글이 없습니다.</p>
        ) : (
          <div class="post-list">
            {categoryPosts.map((post) => (
              <article class="post-card">
                <a href={withBase(`/blog/${post.slug}`)}>
                  <h2>{post.data.title}</h2>
                  {post.data.summary ? <p>{post.data.summary}</p> : null}
                  <span class="post-meta">
                    {post.data.pubDate.toLocaleDateString("ko-KR")}
                  </span>
                </a>
              </article>
            ))}
          </div>
        )}
      </div>
    </div>
  </section>
</BaseLayout>
