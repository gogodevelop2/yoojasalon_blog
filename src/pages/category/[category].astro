---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("posts");
  const categories = Array.from(
    new Set(posts.map((post) => post.data.category).filter(Boolean))
  );

  return categories.map((category) => ({
    params: { category },
    props: { category },
  }));
}

const { category } = Astro.props;
const posts = (await getCollection("posts"))
  .filter((post) => post.data.category === category && post.data.status === "published")
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const allPosts = (await getCollection("posts")).filter(
  (post) => post.data.status === "published"
);
const categories = Array.from(
  new Set(allPosts.map((post) => post.data.category).filter(Boolean))
);
---

<BaseLayout title={`${category} · 유자살롱`} description={`${category} 카테고리 글 모음`} showMusicPlayer={false}>
  <section class="section">
    <div class="blog-layout">
      <aside class="blog-sidebar" aria-label="카테고리">
        <h2 class="sidebar-title">카테고리</h2>
        {categories.length > 0 ? (
          <nav class="category-nav">
            <a class={`category-link${category ? "" : " is-active"}`} href="/blog">
              전체
            </a>
            {categories.map((item) => (
              <a
                class={`category-link${item === category ? " is-active" : ""}`}
                href={`/category/${item}`}
              >
                {item}
              </a>
            ))}
          </nav>
        ) : (
          <p class="sidebar-empty">등록된 카테고리가 없습니다.</p>
        )}
      </aside>
      <div class="blog-content">
        <h1 class="section-heading">{category}</h1>
        {posts.length === 0 ? (
          <p>아직 이 카테고리에 글이 없습니다.</p>
        ) : (
          <div class="post-list">
            {posts.map((post) => (
              <article class="post-card">
                <a href={`/blog/${post.data.slug}`}>
                  <h2>{post.data.title}</h2>
                  {post.data.summary ? <p>{post.data.summary}</p> : null}
                  <span class="post-meta">
                    {post.data.pubDate.toLocaleDateString("ko-KR")}
                  </span>
                </a>
              </article>
            ))}
          </div>
        )}
      </div>
    </div>
  </section>
</BaseLayout>
